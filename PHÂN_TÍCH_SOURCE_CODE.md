# PH√ÇN T√çCH SOURCE CODE - BACKGROUND GENERATOR

## üìã T·ªîNG QUAN

ƒê√¢y l√† ph√¢n t√≠ch chi ti·∫øt source code c·ªßa ·ª©ng d·ª•ng **Background Generator** - m·ªôt web app t·∫°o background chuy√™n nghi·ªáp cho ·∫£nh s·∫£n ph·∫©m b·∫±ng AI.

**Stack c√¥ng ngh·ªá ch√≠nh:**
- Frontend: Next.js (App Router) + React + MUI (Minimal UI template)
- Backend: Next.js API Routes + Supabase (Auth + Storage + Database)
- AI Service: Runware API (remove background + generate background)
- Database: PostgreSQL (qua Supabase)
- Storage: Supabase Storage (buckets: images, processed-images)

---

## 1. C·∫§U TR√öC, NG√îN NG·ªÆ V√Ä C·∫§U H√åNH

### 1.1. C·∫•u tr√∫c th∆∞ m·ª•c ch√≠nh

```
src/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ background-generator/          # Main app pages
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generator/page.jsx         # Trang ch√≠nh t·∫°o background
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/page.jsx         # Dashboard th·ªëng k√™
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ gallery/page.jsx           # Gallery ·∫£nh ƒë√£ x·ª≠ l√Ω
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings/page.jsx          # C√†i ƒë·∫∑t
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îî‚îÄ‚îÄ runware/
‚îÇ           ‚îú‚îÄ‚îÄ route.js               # API proxy ƒë∆°n l·∫ª
‚îÇ           ‚îî‚îÄ‚îÄ batch/route.js         # API x·ª≠ l√Ω theo l√¥
‚îú‚îÄ‚îÄ sections/background-generator/     # UI Components
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ modern-workflow.jsx       # Main workflow UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ image-upload-zone.jsx     # Upload component
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ background-style-selector.jsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ image-preview-panel.jsx
‚îÇ   ‚îî‚îÄ‚îÄ view/
‚îÇ       ‚îî‚îÄ‚îÄ background-generator-new-view.jsx  # Main view controller
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ runware-service.js            # Client service g·ªçi API n·ªôi b·ªô
‚îÇ   ‚îú‚îÄ‚îÄ image-upload-service.js       # Upload ·∫£nh l√™n Supabase
‚îÇ   ‚îú‚îÄ‚îÄ supabase.js                   # Supabase client config
‚îÇ   ‚îú‚îÄ‚îÄ supabase-services.js          # User profile & stats services
‚îÇ   ‚îî‚îÄ‚îÄ runware.js                    # ‚ö†Ô∏è Legacy code (c·∫ßn x√≥a)
‚îî‚îÄ‚îÄ auth/
    ‚îú‚îÄ‚îÄ context/supabase/             # Supabase auth provider
    ‚îî‚îÄ‚îÄ hooks/                        # Auth hooks
```

### 1.2. Ng√¥n ng·ªØ v√† Runtime

- **Ng√¥n ng·ªØ:** JavaScript/JSX (kh√¥ng d√πng TypeScript)
- **Runtime:** Node.js >= 20
- **Framework:** Next.js v·ªõi App Router
- **UI Library:** MUI + Minimal UI template
- **Build Tool:** Turbopack (dev), Next.js build (production)
- **Port:** 3032

### 1.3. C·∫•u h√¨nh quan tr·ªçng

**package.json scripts:**
```json
{
  "dev": "next dev -p 3032 --turbopack",
  "start": "next start -p 3032",
  "build": "next build"
}
```

**Bi·∫øn m√¥i tr∆∞·ªùng c·∫ßn thi·∫øt (.env.local):**
```env
# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=xxx
SUPABASE_SERVICE_ROLE_KEY=xxx  # Ch·ªâ server-side

# Runware AI
RUNWARE_API_KEY=xxx            # Ch·ªâ server-side
RUNWARE_API_URL=https://api.runware.ai

# App Config
PORT=3032
NEXT_PUBLIC_SERVER_URL=http://localhost:3032
```

---

## 2. √ù T∆Ø·ªûNG V√Ä CH·ª®C NƒÇNG C·ª¶A APP

### 2.1. M·ª•c ti√™u ch√≠nh
T·∫°o background chuy√™n nghi·ªáp cho ·∫£nh s·∫£n ph·∫©m b·∫±ng AI, gi√∫p c√°c shop online/photographer t·∫°o ·∫£nh marketing ƒë·∫πp m·∫Øt.

### 2.2. Quy tr√¨nh workflow (4 b∆∞·ªõc)

1. **Upload ·∫¢nh:** Ng∆∞·ªùi d√πng t·∫£i l√™n ·∫£nh s·∫£n ph·∫©m g·ªëc
2. **X√≥a Background:** AI t·ª± ƒë·ªông ph√°t hi·ªán v√† x√≥a background (t·∫°o mask)
3. **Ch·ªçn Style:** Ng∆∞·ªùi d√πng ch·ªçn style c√≥ s·∫µn ho·∫∑c nh·∫≠p prompt t√πy ch·ªânh
4. **T·∫°o Background:** AI sinh background m·ªõi d·ª±a tr√™n style ƒë√£ ch·ªçn

### 2.3. T√≠nh nƒÉng b·ªï sung
- Dashboard th·ªëng k√™ (s·ªë ·∫£nh ƒë√£ x·ª≠ l√Ω, t·ª∑ l·ªá th√†nh c√¥ng)
- Gallery l∆∞u tr·ªØ ·∫£nh ƒë√£ x·ª≠ l√Ω
- Batch processing (x·ª≠ l√Ω nhi·ªÅu ·∫£nh c√πng l√∫c)
- Download ·∫£nh k·∫øt qu·∫£
- T√≠ch h·ª£p Google OAuth qua Supabase

---

## 3. LU·ªíNG HO·∫†T ƒê·ªòNG V√Ä C·∫§U TR√öC REQUEST

### 3.1. Ki·∫øn tr√∫c t·ªïng th·ªÉ

```
Client (UI) ‚Üí RunwareService ‚Üí Next.js API Routes ‚Üí Runware API
     ‚Üì              ‚Üì                    ‚Üì
Supabase Auth ‚Üí Access Token ‚Üí Server Verification
     ‚Üì
Supabase Storage + Database
```

### 3.2. X√°c th·ª±c (Authentication Flow)

**Client-side:**
```javascript
// L·∫•y token t·ª´ Supabase session
const { data: { session } } = await supabase.auth.getSession();
const token = session?.access_token;

// G·ª≠i k√®m header
headers: {
  'Authorization': `Bearer ${token}`
}
```

**Server-side:**
```javascript
// Verify token b·∫±ng Service Role Key
const { data: { user }, error } = await supabase.auth.getUser(token);
if (error || !user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

### 3.3. Format Request m·ªõi (sau refactor)

**POST /api/runware**
```json
{
  "operation": "removeBackground" | "inpainting" | "generateImage" | "upscale" | "uploadImage",
  "data": {
    // Cho removeBackground
    "inputImage": "https://example.com/image.jpg",

    // Cho inpainting (workflow m·ªõi)
    "seedImage": "https://example.com/original.jpg",    // ·∫¢nh g·ªëc
    "maskImage": "https://example.com/mask.png",        // Mask t·ª´ removeBackground
    "positivePrompt": "professional studio background",
    "negativePrompt": "blurry, low quality",

    // Cho generateImage (legacy)
    "prompt": "professional studio background",
    "inputImage": "https://example.com/image.jpg"       // Optional cho img2img
  },
  "options": {
    "model": "runware:102@1",      // FLUX Fill cho inpainting
    "outputFormat": "PNG",
    "outputType": "URL",
    "width": 1024,
    "height": 1024,
    "steps": 25,
    "CFGScale": 7.0,
    "strength": 0.8,               // Cho inpainting
    "maskMargin": 32               // Margin cho mask blending
  }
}
```

**Response th√†nh c√¥ng:**
```json
{
  "success": true,
  "data": {
    "taskUUID": "xxx-xxx-xxx",
    "imageUUID": "xxx-xxx-xxx", 
    "imageURL": "https://runware.ai/result.png",
    "cost": 0.05,
    "operation": "removeBackground"
  }
}
```

### 3.4. Batch Processing

**POST /api/runware/batch**
```json
{
  "files": [
    { "filename": "product1.jpg", "base64": "data:image/jpeg;base64,..." },
    { "filename": "product2.jpg", "base64": "data:image/jpeg;base64,..." }
  ],
  "operation": "removeBackground",
  "options": { "model": "runware:109@1" }
}
```

**Response:**
```json
{
  "success": true,
  "results": [
    { "index": 0, "filename": "product1.jpg", "success": true, "data": {...} },
    { "index": 1, "filename": "product2.jpg", "success": false, "error": "..." }
  ],
  "summary": {
    "total": 2,
    "successful": 1, 
    "failed": 1,
    "totalCost": 0.05
  }
}
```

### 3.5. Database Schema

**B·∫£ng processed_images:**
```sql
CREATE TABLE processed_images (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  original_url TEXT NOT NULL,
  background_removed_url TEXT,
  final_url TEXT,
  status TEXT DEFAULT 'uploaded',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**Storage Buckets:**
- `images`: ·∫¢nh g·ªëc (path: `userId/original/filename`)
- `processed-images`: ·∫¢nh ƒë√£ x·ª≠ l√Ω (path: `userId/processed/imageId/filename`)

---

## 4. ƒêI·ªÇM M·∫†NH HI·ªÜN T·∫°i

‚úÖ **Ki·∫øn tr√∫c ph√¢n t·∫ßng r√µ r√†ng:**
- UI t√°ch bi·ªát trong `sections/`
- Business logic trong `lib/`
- API routes b·∫£o m·∫≠t API key

‚úÖ **B·∫£o m·∫≠t t·ªët:**
- API key ch·ªâ ·ªü server-side
- X√°c th·ª±c nh·∫•t qu√°n qua Supabase token
- Validate input ƒë·∫ßy ƒë·ªß

‚úÖ **UX/UI ch·∫•t l∆∞·ª£ng:**
- Workflow stepper tr·ª±c quan
- Loading states v√† error handling chi ti·∫øt
- Responsive design v·ªõi MUI

‚úÖ **Retry logic v√† error handling:**
- Server t·ª± ƒë·ªông retry khi l·ªói 5xx
- Validate response t·ª´ Runware API
- Chu·∫©n h√≥a error messages

---

## 5. V·∫§N ƒê·ªÄ V√Ä ƒêI·ªÇM C·∫¶N C·∫¢I THI·ªÜN

### üî¥ V·∫•n ƒë·ªÅ nghi√™m tr·ªçng

1. **Code legacy tr√πng l·∫∑p:**
   - `src/lib/runware.js` kh√¥ng ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ng v·∫´n t·ªìn t·∫°i
   - G√¢y confusion v√† tƒÉng bundle size

2. **Naming kh√¥ng nh·∫•t qu√°n:**
   - `background_removed_url` vs `background_removed_supabase_url`
   - `final_url` vs `final_supabase_url`
   - Kh√≥ maintain v√† debug

3. **Validation r·∫£i r√°c:**
   - Kh√¥ng c√≥ schema validation t·∫≠p trung
   - Logic validate l·∫∑p l·∫°i ·ªü nhi·ªÅu n∆°i

### üü° V·∫•n ƒë·ªÅ trung b√¨nh

4. **HTTP client kh√¥ng th·ªëng nh·∫•t:**
   - `runware-service.js` d√πng `fetch`
   - `auth-provider.jsx` set headers cho `axios`
   - Kh√¥ng c√≥ interceptors chung

5. **Batch processing ch·∫≠m:**
   - X·ª≠ l√Ω tu·∫ßn t·ª± v·ªõi delay 500ms
   - Kh√¥ng t·∫≠n d·ª•ng concurrency

6. **Logging kh√¥ng chuy√™n nghi·ªáp:**
   - Nhi·ªÅu `console.log` trong production
   - Log sensitive data (tokens, base64)

### üü¢ C·∫£i thi·ªán nh·ªè

7. **TypeScript:**
   - Hi·ªán t·∫°i d√πng JavaScript thu·∫ßn
   - Kh√≥ catch l·ªói type runtime

8. **Testing:**
   - Ch∆∞a c√≥ unit tests
   - Kh√≥ ƒë·∫£m b·∫£o quality khi refactor

---

## 6. K·∫æ HO·∫†CH REFACTOR (3 GIAI ƒêO·∫†N)

### ‚úÖ Giai ƒëo·∫°n 1: D·ªçn d·∫πp v√† chu·∫©n h√≥a (HO√ÄN TH√ÄNH)

**M·ª•c ti√™u:** Lo·∫°i b·ªè code th·ª´a, chu·∫©n h√≥a interfaces

**C√¥ng vi·ªác ƒë√£ ho√†n th√†nh:**
- [x] X√≥a `src/lib/runware.js` (legacy)
- [x] T·∫°o schema validation v·ªõi Zod cho `/api/runware`
- [x] Chu·∫©n h√≥a naming DB fields (`mask_url`, `final_supabase_url`)
- [x] T√°ch `verifyAuth` th√†nh utility function (`src/server/auth/verify-auth.js`)
- [x] T·∫°o `src/server/runware/client.js` wrap Runware API calls
- [x] C·∫≠p nh·∫≠t workflow t·ª´ `generateImage` sang `inpainting` v·ªõi `seedImage` + `maskImage`
- [x] C·∫≠p nh·∫≠t client service v√† UI components ƒë·ªÉ s·ª≠ d·ª•ng workflow m·ªõi

### üöÄ Giai ƒëo·∫°n 2: T·ªëi ∆∞u hi·ªáu nƒÉng (2-3 ng√†y)

**M·ª•c ti√™u:** C·∫£i thi·ªán performance v√† UX

**C√¥ng vi·ªác:**
- [ ] Implement concurrency cho batch processing (p-limit)
- [ ] Th√™m proper logging v·ªõi levels (debug/info/error)
- [ ] Optimize image handling (lazy loading, compression)
- [ ] Add caching cho frequently used data
- [ ] Implement proper error boundaries

### üîß Giai ƒëo·∫°n 3: Ch·∫•t l∆∞·ª£ng d√†i h·∫°n (3-5 ng√†y)

**M·ª•c ti√™u:** ƒê·∫£m b·∫£o maintainability v√† scalability

**C√¥ng vi·ªác:**
- [ ] Migrate sang TypeScript (√≠t nh·∫•t cho lib/ v√† server/)
- [ ] Th√™m unit tests cho core functions
- [ ] Setup CI/CD pipeline
- [ ] Add monitoring v√† analytics
- [ ] Documentation API v·ªõi OpenAPI/Swagger

---

## 7. NEXT STEPS

### ∆Øu ti√™n cao (L√†m ngay)
1. X√≥a code legacy `runware.js`
2. Chu·∫©n h√≥a database schema naming
3. T·∫°o schema validation cho API endpoints

### ∆Øu ti√™n trung b√¨nh (Tu·∫ßn t·ªõi)
4. Implement proper logging
5. Optimize batch processing
6. Add error boundaries

### ∆Øu ti√™n th·∫•p (Th√°ng t·ªõi)
7. TypeScript migration
8. Comprehensive testing
9. Performance monitoring

---

## üìû LI√äN H·ªÜ V√Ä H·ªñ TR·ª¢

N·∫øu c·∫ßn h·ªó tr·ª£ implement b·∫•t k·ª≥ ph·∫ßn n√†o trong k·∫ø ho·∫°ch refactor, h√£y cho m√¨nh bi·∫øt!

**T√†i li·ªáu tham kh·∫£o:**
- [Supabase Documentation](https://supabase.com/docs)
- [Runware API Documentation](https://docs.runware.ai)
- [Next.js App Router](https://nextjs.org/docs/app)
- [MUI Components](https://mui.com/components/)

---

## 8. CHI TI·∫æT K·ª∏ THU·∫¨T B·ªî SUNG

### 8.1. Runware API Integration Details

**Models ƒë∆∞·ª£c s·ª≠ d·ª•ng:**
- `runware:109@1`: Remove background (c√≥ h·ªó tr·ª£ returnOnlyMask)
- `runware:100@1`: Text-to-image generation
- `runware:101@1`: FLUX model (ch·∫•t l∆∞·ª£ng cao h∆°n)
- `runware:111@1`: Image upscaling

**Settings t·ªëi ∆∞u cho removeBackground:**
```javascript
const settings = {
  returnOnlyMask: true,           // Tr·∫£ v·ªÅ mask thay v√¨ ·∫£nh ƒë√£ x√≥a BG
  postProcessMask: true,          // C·∫£i thi·ªán ch·∫•t l∆∞·ª£ng mask
  alphaMatting: true,             // L√†m m·ªãn edges
  alphaMattingForegroundThreshold: 240,
  alphaMattingBackgroundThreshold: 15,
  alphaMattingErodeSize: 8,
  rgba: [255, 255, 255, 0]        // Background trong su·ªët
};
```

**Parameters t·ªëi ∆∞u cho generateBackground:**
```javascript
const options = {
  model: 'runware:101@1',         // FLUX model
  width: 1024,
  height: 1024,
  steps: 25,                      // TƒÉng cho ch·∫•t l∆∞·ª£ng t·ªët h∆°n
  CFGScale: 7.0,                  // Balance gi·ªØa prompt adherence v√† creativity
  strength: 0.75,                 // Cho img2img
  scheduler: 'Euler',             // Deterministic scheduler
  outputFormat: 'PNG',
  outputQuality: 95
};
```

### 8.2. Database Relationships v√† Indexes

**Indexes c·∫ßn thi·∫øt:**
```sql
-- Index cho query theo user
CREATE INDEX idx_processed_images_user_id ON processed_images(user_id);

-- Index cho query theo status
CREATE INDEX idx_processed_images_status ON processed_images(status);

-- Index cho query theo th·ªùi gian (dashboard stats)
CREATE INDEX idx_processed_images_created_at ON processed_images(created_at);

-- Composite index cho pagination
CREATE INDEX idx_processed_images_user_created ON processed_images(user_id, created_at DESC);
```

**Row Level Security (RLS) Policies:**
```sql
-- Users ch·ªâ c√≥ th·ªÉ xem/s·ª≠a ·∫£nh c·ªßa m√¨nh
CREATE POLICY "Users can view own images" ON processed_images
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own images" ON processed_images
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own images" ON processed_images
  FOR UPDATE USING (auth.uid() = user_id);
```

### 8.3. Error Codes v√† Handling

**Client-side Error Types:**
```javascript
const ERROR_TYPES = {
  UPLOAD_FAILED: 'UPLOAD_FAILED',
  REMOVE_BG_FAILED: 'REMOVE_BG_FAILED',
  GENERATE_BG_FAILED: 'GENERATE_BG_FAILED',
  AUTH_REQUIRED: 'AUTH_REQUIRED',
  QUOTA_EXCEEDED: 'QUOTA_EXCEEDED',
  INVALID_IMAGE: 'INVALID_IMAGE'
};
```

**Server-side Error Mapping:**
```javascript
const mapRunwareError = (error) => {
  if (error.message?.includes('quota')) return 'QUOTA_EXCEEDED';
  if (error.message?.includes('invalid image')) return 'INVALID_IMAGE';
  if (error.status === 401) return 'AUTH_REQUIRED';
  return 'UNKNOWN_ERROR';
};
```

### 8.4. Performance Optimizations

**Image Optimization:**
```javascript
// Resize ·∫£nh tr∆∞·ªõc khi upload n·∫øu qu√° l·ªõn
const MAX_DIMENSION = 2048;
const resizeImage = (file) => {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();

    img.onload = () => {
      const { width, height } = calculateDimensions(img, MAX_DIMENSION);
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      canvas.toBlob(resolve, 'image/jpeg', 0.9);
    };

    img.src = URL.createObjectURL(file);
  });
};
```

**Caching Strategy:**
```javascript
// Cache user stats trong 5 ph√∫t
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes
const statsCache = new Map();

const getCachedStats = (userId) => {
  const cached = statsCache.get(userId);
  if (cached && Date.now() - cached.timestamp < CACHE_TTL) {
    return cached.data;
  }
  return null;
};
```

### 8.5. Security Best Practices

**Input Validation:**
```javascript
const validateImageUpload = (file) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
  const maxSize = 20 * 1024 * 1024; // 20MB

  if (!allowedTypes.includes(file.type)) {
    throw new Error('File type not supported');
  }

  if (file.size > maxSize) {
    throw new Error('File too large');
  }
};
```

**Rate Limiting:**
```javascript
// Implement rate limiting cho API routes
const rateLimiter = new Map();

const checkRateLimit = (userId, limit = 10, window = 60000) => {
  const now = Date.now();
  const userRequests = rateLimiter.get(userId) || [];

  // Remove old requests outside window
  const validRequests = userRequests.filter(time => now - time < window);

  if (validRequests.length >= limit) {
    throw new Error('Rate limit exceeded');
  }

  validRequests.push(now);
  rateLimiter.set(userId, validRequests);
};
```

### 8.6. Monitoring v√† Analytics

**Key Metrics c·∫ßn track:**
```javascript
const METRICS = {
  // Business metrics
  IMAGES_PROCESSED_TOTAL: 'images_processed_total',
  IMAGES_PROCESSED_SUCCESS: 'images_processed_success',
  IMAGES_PROCESSED_FAILED: 'images_processed_failed',

  // Performance metrics
  API_RESPONSE_TIME: 'api_response_time',
  RUNWARE_API_LATENCY: 'runware_api_latency',
  IMAGE_UPLOAD_TIME: 'image_upload_time',

  // User metrics
  DAILY_ACTIVE_USERS: 'daily_active_users',
  USER_RETENTION_RATE: 'user_retention_rate'
};
```

**Health Check Endpoint:**
```javascript
// GET /api/health
export async function GET() {
  const checks = {
    database: await checkDatabase(),
    storage: await checkStorage(),
    runware: await checkRunwareAPI(),
    timestamp: new Date().toISOString()
  };

  const isHealthy = Object.values(checks).every(check =>
    typeof check === 'boolean' ? check : check.status === 'ok'
  );

  return NextResponse.json(checks, {
    status: isHealthy ? 200 : 503
  });
}
```

---

## 9. DEPLOYMENT V√Ä DEVOPS

### 9.1. Environment Setup

**Development:**
```bash
# Clone repository
git clone <repo-url>
cd productBackground

# Install dependencies
yarn install

# Setup environment
cp .env.example .env.local
# Fill in required variables

# Run development server
yarn dev
```

**Production Build:**
```bash
# Build application
yarn build

# Start production server
yarn start

# Or deploy to Vercel
vercel --prod
```

### 9.2. Docker Configuration

**Dockerfile:**
```dockerfile
FROM node:20-alpine AS base
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

FROM base AS build
COPY . .
RUN npm run build

FROM base AS runtime
COPY --from=build /app/.next ./.next
COPY --from=build /app/public ./public
EXPOSE 3032
CMD ["npm", "start"]
```

**docker-compose.yml:**
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "3032:3032"
    environment:
      - NODE_ENV=production
    env_file:
      - .env.local
```

### 9.3. CI/CD Pipeline

**GitHub Actions workflow:**
```yaml
name: Deploy
on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm ci
      - run: npm run lint
      - run: npm run test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: vercel/action@v1
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
```

---

## 10. TROUBLESHOOTING GUIDE

### 10.1. Common Issues

**Issue: "Runware API key ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh"**
```bash
# Solution: Check environment variables
echo $RUNWARE_API_KEY
# Make sure it's set in .env.local
```

**Issue: "Invalid or expired token"**
```bash
# Solution: Check Supabase auth
# 1. Verify SUPABASE_SERVICE_ROLE_KEY is correct
# 2. Check if user session is valid
# 3. Ensure token is passed in Authorization header
```

**Issue: Upload fails with "File too large"**
```javascript
// Solution: Check file size limits
const MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB
if (file.size > MAX_FILE_SIZE) {
  // Compress or resize image before upload
}
```

### 10.2. Debug Commands

**Check API connectivity:**
```bash
# Test Runware API
curl -X GET http://localhost:3032/api/runware \
  -H "Authorization: Bearer <supabase-token>"

# Test Supabase connection
curl -X GET "<SUPABASE_URL>/rest/v1/processed_images" \
  -H "apikey: <SUPABASE_ANON_KEY>" \
  -H "Authorization: Bearer <user-token>"
```

**Database queries for debugging:**
```sql
-- Check recent processed images
SELECT id, status, created_at, updated_at
FROM processed_images
ORDER BY created_at DESC
LIMIT 10;

-- Check user activity
SELECT user_id, COUNT(*) as total_images,
       COUNT(CASE WHEN status = 'completed' THEN 1 END) as completed
FROM processed_images
GROUP BY user_id;
```

---

## 11. FUTURE ENHANCEMENTS

### 11.1. Planned Features

**Short-term (1-2 months):**
- [ ] Batch processing UI improvements
- [ ] More background style presets
- [ ] Image history and favorites
- [ ] Basic usage analytics dashboard

**Medium-term (3-6 months):**
- [ ] Advanced editing tools (crop, rotate, filters)
- [ ] Team collaboration features
- [ ] API for third-party integrations
- [ ] Mobile app (React Native)

**Long-term (6+ months):**
- [ ] Custom AI model training
- [ ] Video background replacement
- [ ] Marketplace for background templates
- [ ] Enterprise features (SSO, admin panel)

### 11.2. Technical Debt

**High Priority:**
- [ ] Complete TypeScript migration
- [ ] Comprehensive test coverage (>80%)
- [ ] Performance optimization (Core Web Vitals)
- [ ] Security audit and penetration testing

**Medium Priority:**
- [ ] Database optimization and indexing
- [ ] CDN setup for image delivery
- [ ] Monitoring and alerting system
- [ ] Backup and disaster recovery

**Low Priority:**
- [ ] Code documentation (JSDoc/TSDoc)
- [ ] Accessibility improvements (WCAG 2.1)
- [ ] Internationalization (i18n)
- [ ] Progressive Web App (PWA) features

---

*T√†i li·ªáu n√†y ƒë∆∞·ª£c t·∫°o v√†o ng√†y: ${new Date().toLocaleDateString('vi-VN')}*
*Phi√™n b·∫£n: 1.0*
